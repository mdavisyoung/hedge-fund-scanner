name: Autonomous Trading

on:
  schedule:
    # Run every 5 minutes during market hours (9:30 AM - 4:00 PM ET = 13:30 - 20:00 UTC)
    # Monday to Friday only
    - cron: '*/5 13-20 * * 1-5'

  # Allow manual triggering
  workflow_dispatch:

jobs:
  trade:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Check market hours
        id: market_check
        run: |
          # Check if current time is within market hours (9:30 AM - 4:00 PM ET)
          HOUR=$(TZ='America/New_York' date +%H)
          MINUTE=$(TZ='America/New_York' date +%M)
          DAY=$(TZ='America/New_York' date +%u)

          # Market hours: 9:30 AM (09:30) to 4:00 PM (16:00) ET
          # Monday=1 to Friday=5

          if [ $DAY -ge 1 ] && [ $DAY -le 5 ]; then
            if [ $HOUR -eq 9 ] && [ $MINUTE -ge 30 ]; then
              echo "market_open=true" >> $GITHUB_OUTPUT
            elif [ $HOUR -ge 10 ] && [ $HOUR -lt 16 ]; then
              echo "market_open=true" >> $GITHUB_OUTPUT
            else
              echo "market_open=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "market_open=false" >> $GITHUB_OUTPUT
          fi

      - name: Run autonomous trader
        if: steps.market_check.outputs.market_open == 'true'
        env:
          ALPACA_API_KEY: ${{ secrets.ALPACA_API_KEY }}
          ALPACA_SECRET_KEY: ${{ secrets.ALPACA_SECRET_KEY }}
          XAI_API_KEY: ${{ secrets.XAI_API_KEY }}
          SENDGRID_API_KEY: ${{ secrets.SENDGRID_API_KEY }}
        run: |
          cd trader
          python run_autonomous.py --mode once --paper

      - name: Commit updated data
        if: steps.market_check.outputs.market_open == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          # Check if data directory has files to commit
          if [ -n "$(ls -A data/*.json 2>/dev/null)" ]; then
            git add data/*.json
            if ! git diff --quiet HEAD -- data/ 2>/dev/null; then
              git commit -m "ğŸ¤– Trading update: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
              git push
              echo "âœ… Trading data committed and pushed"
            else
              echo "â„¹ï¸ No changes to commit"
            fi
          else
            echo "â„¹ï¸ No data files to commit"
          fi

      - name: Market closed message
        if: steps.market_check.outputs.market_open == 'false'
        run: |
          echo "Market is currently closed. Skipping trading."
          TZ='America/New_York' date
